name: Flutter CI/CD

on:
  pull_request:
  push:
    branches:
      - main
      - 'release/*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      # with:
      #   flutter-version: '2.8.1'

    - name: Install Dependencies
      run: flutter pub get

    - name: Run Tests and Analyze
      run: |
        flutter test
        flutter analyze

    - name: Build and Upload APK
      if: startsWith(github.ref, 'refs/heads/release/') || github.ref == 'refs/heads/main'
      run: |
        VERSION=$(grep version pubspec.yaml | tail -1 | cut -d ":" -f 2 | xargs)
        PACKAGE=$(grep package android/app/src/main/AndroidManifest.xml | cut -d '"' -f 2)
        flutter build apk --release


    - name: Upload to Releases
      if: startsWith(github.ref, 'refs/heads/release/') || github.ref == 'refs/heads/main'
      uses: actions/upload-release-asset@v1
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: build/app/outputs/flutter-apk/${{ needs.build.outputs.filename }}
        asset_name: ${{ needs.build.outputs.filename }}
        tag: ${{ github.ref }}
